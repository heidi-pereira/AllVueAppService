fernetKeySecretName: airflow-fernet-secret

images:
  airflow:
    repository: savantabvairflow.azurecr.io/airflow
    tag: 3.0.2
    # Specifying digest takes precedence over tag.
    digest: ~
    pullPolicy: IfNotPresent
  # To avoid images with user code, you can turn this to 'true' and
  # all the 'run-airflow-migrations' and 'wait-for-airflow-migrations' containers/jobs
  # will use the images from 'defaultAirflowRepository:defaultAirflowTag' values
  # to run and wait for DB migrations .
  useDefaultImageForMigration: false
  # timeout (in seconds) for airflow-migrations to complete
  migrationsWaitTimeout: 60
  pod_template:
    # Note that `images.pod_template.repository` and `images.pod_template.tag` parameters
    # can be overridden in `config.kubernetes` section. So for these parameters to have effect
    # `config.kubernetes.worker_container_repository` and `config.kubernetes.worker_container_tag`
    # must be not set .
    repository: savantabvairflow.azurecr.io/airflow
    tag: 3.0.2
    pullPolicy: IfNotPresent
  flower:
    repository: savantabvairflow.azurecr.io/airflow
    tag: 3.0.2
    pullPolicy: IfNotPresent
  statsd:
    repository: savantabvairflow.azurecr.io/statsd-exporter
    tag: v0.26.1
    pullPolicy: IfNotPresent
  pgbouncer:
    repository: savantabvairflow.azurecr.io/airflow
    tag: airflow-pgbouncer-2024.01.19-1.21.0
    pullPolicy: IfNotPresent
  pgbouncerExporter:
    repository: savantabvairflow.azurecr.io/airflow
    tag: airflow-pgbouncer-exporter-2024.06.18-0.17.0
    pullPolicy: IfNotPresent
  gitSync:
    repository: savantabvairflow.azurecr.io/git-sync
    tag: v4.1.0
    pullPolicy: IfNotPresent


# Airflow executor
executor: "KubernetesExecutor"

# Environment variables for all airflow containers
env:
  - name: ENVIRONMENT
    value: test
    
  - name: AIRFLOW__WEBSERVER__INSTANCE_NAME
    value: "Test DAGs"

extraEnv: |
  - name: AIRFLOW__CORE__DEFAULT_TIMEZONE
    value: 'America/New_York'

  - name: AIRFLOW__CORE__TEST_CONNECTION
    value: 'Enabled'

  - name: AZURE_SQL_SERVER_CONN_ID
    value: 'azure_sql_test_beta'

  - name: AZURE_SQL_SERVER_METADATA_DATABASE
    value: 'AllVueConfig_TestEnv_LiveSnapshotSurveys'
  
  - name: AZURE_SQL_SERVER_SURVEY_DATABASE
    value: 'VueExport'

  - name: AZURE_SQL_SERVER_AUTH_USERS_DATABASE
    value: 'MIG.Auth.Server.USers.Test'

  - name: SNOWFLAKE_DATABASE
    value: 'TEST__VUE'

  - name: SNOWFLAKE_PRIVATE_KEY
    valueFrom:
      secretKeyRef:
        name: snowflake-user-key
        key: snowflake-user-key

  - name: SNOWFLAKE_DEPLOYMENT_AGENT
    value: 'TEST_DEPLOYMENT_AGENT'

  - name: SNOWFLAKE_APPLICATION_AGENT
    value: 'TEST_READWRITE_AGENT'

  - name: SNOWFLAKE_DEPLOYMENT_ROLE
    value: 'TEST_ALTER_ROLE'

  - name: SNOWFLAKE_APPLICATION_ROLE
    value: 'TEST_READWRITE_ROLE'

  - name: FULL_COPY_CHUNK_SIZE
    value: '100000'
  
  - name: MOCK_SNOWFLAKE
    value: 'False'

  - name: SNOWFLAKE_KEY_ENCRYPTION_PASSWORD
    valueFrom:
      secretKeyRef:
        name: snowflake-key-encryption-password
        key: snowflake-key-encryption-password

  - name: SNOWFLAKE_AGENT_PRIVATE_KEY
    valueFrom:
      secretKeyRef:
        name: snowflake-agent-private-key
        key: snowflake-agent-private-key

  - name: BLOB_EXPORT_SAS_TOKEN
    valueFrom:
      secretKeyRef:
        name: blob-export-sas-token
        key: blob-export-sas-token

  - name: POLYBASE_AZURE_BLOB_ACCOUNT_NAME
    value: 'savantatechbackups'

  - name: POLYBASE_AZURE_BLOB_CONTAINER
    value: 'data-exports'

postgresql:
  enabled: true
  image:
    registry: savantabvairflow.azurecr.io
    repository: bitnami/postgresql
    tag: 16.1.0-debian-11-r15
  # postgresqlDatabase: airflow_test

#data:
  #metadataSecretName: airflow-metadata-secret

# Enable pgbouncer. See https://airflow.apache.org/docs/helm-chart/stable/production-guide.html#pgbouncer
pgbouncer:
  enabled: true

dags:
  gitSync:
    enabled: true
    repo: git@github.com:Savanta-Tech/Vue.git
    branch: airflow-test
    rev: HEAD
    depth: 1
    maxFailures: 0
    subPath: "src/Vue.Snowflake/Airflow/dags"
    sshKeySecret: airflow-git-ssh-secret
    knownHosts: |
      github.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCj7ndNxQowgcQnjshcLrqPEiiphnt+VTTvDP6mHBL9j1aNUkY4Ue1gvwnGLVlOhGeYrnZaMgRK6+PKCUXaDbC7qtbW8gIkhL7aGCsOr/C56SJMy/BCZfxd1nWzAOxSDPgVsmerOBYfNqltV9/hWCqBywINIR+5dIg6JTJ72pcEpEjcYgXkE2YEFXV1JHnsKgbLWNlhScqb2UmyRkQyytRLtL+38TGxkxCflmO+5Z8CSSNY7GidjMIZ7Q4zMjA2n1nGrlTDkzwDCsw+wqFPGQA179cnfGWOWRVruj16z6XyvxvjJwbz0wQZ75XK5tKSb7FNyeIEs4TT4jk+S4dhPeAUC5y+bDYirYgM4GC7uEnztnZyaVWQ7B381AK4Qdrwt51ZqExKbQpTUNn+EjqoTwvqNj4kqx5QUCI0ThS/YkOxJCXmPUWZbhjpCg56i+2aB6CmK2JGhn57K5mj0MNdBXA4/WnwH6XoPWJzK5Nyu2zB3nAZp+S5hpQs+p1vN1/wsjk=

logs:
  persistence:
    enabled: true
    existingClaim: pvc-airflow-logs-azurefile-test

config:
  logging:
    # Keep logs for 7 days (adjust as needed)
    logging_level: INFO
  core:
    log_retention_days: 7

triggerer:
  logGroomerSidecar:
    enabled: true

scheduler:
  logGroomerSidecar:
    enabled: true

workers:
  logGroomerSidecar:
    enabled: true